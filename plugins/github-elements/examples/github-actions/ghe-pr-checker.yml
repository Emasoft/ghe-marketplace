# GitHub Elements - PR Thread Checker
# Validates that PRs are properly linked to GHE threads
# Checks branch naming and issue linkage

name: GHE PR Thread Checker

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read
  issues: read
  pull-requests: write

jobs:
  check-pr-thread:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate PR has GHE thread link
        uses: anthropics/claude-code-action@v1
        with:
          # Authentication: Use GitHub App (recommended) or API key
          # Install GitHub App with: /install-github-app in Claude Code
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          # Or use API key instead:
          # anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            TASK: GitHub Elements PR Validation
            REPOSITORY: ${{ github.repository }}
            PR_NUMBER: ${{ github.event.pull_request.number }}
            PR_TITLE: ${{ github.event.pull_request.title }}
            PR_BODY: |
              ${{ github.event.pull_request.body }}
            PR_BRANCH: ${{ github.event.pull_request.head.ref }}
            BASE_BRANCH: ${{ github.event.pull_request.base.ref }}

            You are validating that this PR follows GitHub Elements (GHE) workflow conventions.

            VALIDATION RULES:

            1. ISSUE LINKAGE (Required):
               PR body should contain a link to a GHE thread using:
               - "Closes #N" or "Fixes #N" or "Resolves #N"
               - Or explicit reference like "GHE Thread: #N"

            2. BRANCH NAMING (Recommended):
               Branch should follow pattern: feature/{epic-name}-{description}
               Examples:
               - feature/jwt-auth-implement-login
               - feature/payment-integration-stripe-setup
               - fix/jwt-auth-token-expiry

            3. LINKED ISSUE VALIDATION:
               If issue is linked, verify it has GHE labels:
               - Should have type:dev, type:test, or type:review
               - Should have a phase label
               - Should be in-progress or have been claimed

            VALIDATION STEPS:

            1. Parse PR body for issue references
            2. Check branch name pattern
            3. If issue found, check its labels
            4. Determine overall compliance

            OUTCOMES:

            A. COMPLIANT: PR properly links to valid GHE thread
               - Post brief confirmation comment (optional, can skip)

            B. MISSING LINK: No issue reference found
               - Post warning comment suggesting adding link

            C. INVALID LINK: Linked issue is not a GHE thread
               - Post comment explaining the issue needs GHE labels

            D. BRANCH PATTERN: Branch doesn't follow convention
               - Post soft warning (not blocking, just FYI)

            COMMENT FORMAT (only if issues found):
            ```
            ## GHE PR Validation

            **Status**: [COMPLIANT / NEEDS ATTENTION]

            [If issues found, list them here with suggestions]

            ### Recommendations:
            - [Specific actionable items]

            ---
            *This is an automated check from the GHE PR Validator.*
            ```

            Be helpful, not blocking. This is advisory, not a gate.

          claude_args: |
            --max-turns 8
            --model claude-sonnet-4-20250514
