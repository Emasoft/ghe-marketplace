{
  "hooks": {
    "SessionStart": [
      {
        "hooks": [
          {
            "type": "prompt",
            "prompt": "## GHE Context Loader (Athena)\n\n### Step 0: Detect Git Repositories\n\nFirst, find all git repositories:\n\n```bash\nfind . -name \".git\" -type d 2>/dev/null | head -20\n```\n\nFor each repo found, get its remote:\n```bash\ngit -C <repo-path> remote get-url origin 2>/dev/null\n```\n\n### Step 1: Check for GHE Configuration\n\nFor each detected repo, check if `.claude/ghe.local.md` exists:\n\n**IF NO CONFIG FOUND IN ANY REPO:**\n\n→ **TRIGGER INTERACTIVE SETUP**\n\nTell the user:\n```\nGHE (GitHub-Elements) detected git repositories but no configuration found.\nStarting interactive setup...\n```\n\nThen run the SAME setup flow as `/ghe:setup`:\n\n1. **If multiple repos**: Ask which one to track\n   ```json\n   {\n     \"questions\": [{\n       \"question\": \"Which repository should GHE track?\",\n       \"header\": \"Repository\",\n       \"multiSelect\": false,\n       \"options\": [{\"label\": \"<repo-name>\", \"description\": \"<remote-url>\"}]\n     }]\n   }\n   ```\n\n2. **Ask enforcement level**:\n   ```json\n   {\n     \"questions\": [\n       {\n         \"question\": \"Enable GHE workflow tracking for this repository?\",\n         \"header\": \"Enable\",\n         \"multiSelect\": false,\n         \"options\": [\n           {\"label\": \"Yes\", \"description\": \"Activate GHE with DEV->TEST->REVIEW workflow\"},\n           {\"label\": \"No\", \"description\": \"Disable GHE for this repository\"}\n         ]\n       },\n       {\n         \"question\": \"How many warnings before enforcing phase rules?\",\n         \"header\": \"Warnings\",\n         \"multiSelect\": false,\n         \"options\": [\n           {\"label\": \"1 warning\", \"description\": \"Strict - block after first warning\"},\n           {\"label\": \"3 warnings\", \"description\": \"Standard - progressive enforcement (recommended)\"},\n           {\"label\": \"5 warnings\", \"description\": \"Lenient - more flexibility before blocking\"}\n         ]\n       }\n     ]\n   }\n   ```\n\n3. **Create config file** at `<repo>/.claude/ghe.local.md`\n4. **Create GitHub labels** (phase:dev, phase:test, etc.)\n5. **Update .gitignore**\n\n**IF CONFIG FOUND:**\n\n→ **Load settings and continue**\n\nParse YAML frontmatter from `.claude/ghe.local.md`:\n- `enabled`: If false, skip all GHE features silently\n- `current_issue`: Resume tracking if set\n- `current_phase`: Current workflow phase\n- `warnings_before_enforce`: Enforcement threshold\n- `violation_count`: Current violation count\n\n### Step 2: Check for Active Work (if enabled)\n\nIf `enabled: true` and `current_issue` is set:\n\n1. **Verify issue still exists**:\n   ```bash\n   gh issue view $ISSUE --json number,state,labels\n   ```\n\n2. **Report active tracking**:\n   ```\n   GHE: Resuming work on Issue #N\n   Phase: DEV/TEST/REVIEW\n   ```\n\nIf no active issue but config exists:\n1. **Check for in-progress issues**:\n   ```bash\n   gh issue list --assignee @me --label \"in-progress\" --json number,title,labels\n   ```\n2. **Report available work** if any found\n\n### Step 3: SERENA Memory Sync\n\nIf `serena_sync: true` (always true by default):\n- Check `.serena/memories/activeContext.md`\n- Verify consistency with GitHub state\n- Report discrepancies if any\n\n### Quick Reference\n\n| Scenario | Action |\n|----------|--------|\n| No repos found | Silent (not a GHE project) |\n| Repos but no config | **Trigger interactive setup** |\n| Config with enabled:false | Silent skip |\n| Config with enabled:true | Load and report active work |"
          }
        ]
      }
    ],
    "UserPromptSubmit": [
      {
        "hooks": [
          {
            "type": "prompt",
            "prompt": "## GHE Issue Tracker (Mnemosyne)\n\n### CRITICAL: SENSITIVE DATA REDACTION\n\n**BEFORE posting ANY content to GitHub, you MUST redact sensitive data!**\n\nReplace the following with `✕✕✕✕` (Unicode redaction block):\n\n| Type | Pattern | Example → Redacted |\n|------|---------|--------------------|\n| **API Keys** | `sk-...`, `api_key=...`, `apikey:...` | `sk-abc123` → `✕✕✕✕` |\n| **Tokens** | `token=...`, `bearer ...`, `ghp_...`, `gho_...` | `ghp_abc123` → `✕✕✕✕` |\n| **Passwords** | `password=...`, `passwd:...`, `pwd=...` | `password=secret` → `password=✕✕✕✕` |\n| **Private Emails** | Emails NOT ending in `@noreply.github.com` or `@users.noreply.github.com` | `john@gmail.com` → `✕✕✕✕@✕✕✕✕` |\n| **User Paths (macOS)** | `/Users/<username>/...` - redact the username component | `/Users/johndoe/Code/Project` → `/Users/✕✕✕✕/Code/Project` |\n| **User Paths (Linux)** | `/home/<username>/...` - redact the username component | `/home/johndoe/projects/app` → `/home/✕✕✕✕/projects/app` |\n| **User Paths (Windows)** | `C:\\Users\\<username>\\...` - redact the username component | `C:\\Users\\JohnDoe\\Documents\\` → `C:\\Users\\✕✕✕✕\\Documents\\` |\n| **Real Names** | Names appearing in paths or configs (not GitHub usernames) | Keep GitHub usernames, redact real names |\n| **AWS Keys** | `AKIA...`, `aws_access_key_id` | `AKIAIOSFODNN7EXAMPLE` → `✕✕✕✕` |\n| **Private Keys** | `-----BEGIN ... PRIVATE KEY-----` | Entire block → `[PRIVATE KEY REDACTED]` |\n| **Connection Strings** | `mongodb://...`, `postgres://...`, `mysql://...` | Redact credentials in URL |\n\n**IMPORTANT**: Do NOT break code snippets!\n- Only replace the sensitive VALUES, not the variable names\n- Keep code structure intact\n- Example: `API_KEY = \"sk-abc123\"` → `API_KEY = \"✕✕✕✕\"`\n\n---\n\n**TRIGGER DETECTION**: Check if the user's message contains any of these patterns:\n- \"lets work on this new issue\"\n- \"let's work on this new issue\"\n- \"lets work on issue\"\n- \"let's work on issue\"\n- \"lets resume working on issue\"\n- \"let's resume working on issue\"\n- \"work on issue #\"\n- \"switch to issue #\"\n\n### If trigger detected:\n\n1. **Extract issue number** (if present):\n   - Pattern: `issue #(\\d+)` or `issue (\\d+)` or `#(\\d+)`\n   - If no number, this is a NEW issue request\n\n2. **For NEW issue**:\n   - Ask user for issue title and description\n   - **REDACT sensitive data from title/description before creating**\n   - Create issue: `gh issue create --title \"TITLE\" --body \"BODY\" --label \"phase:dev\"`\n   - Assign to self: `gh issue edit NUMBER --add-assignee @me --add-label \"in-progress\"`\n   - Update `current_issue` in `.claude/ghe.local.md`\n   - Create worktree: `git worktree add ../ghe-worktrees/issue-NUMBER -b issue-NUMBER main`\n\n3. **For EXISTING issue**:\n   - Verify issue exists: `gh issue view NUMBER`\n   - Check current phase from labels (phase:dev, phase:test, phase:review)\n   - Claim if not assigned: `gh issue edit NUMBER --add-assignee @me --add-label \"in-progress\"`\n   - Update `current_issue` in `.claude/ghe.local.md`\n   - Create worktree if not exists\n\n4. **Start automatic transcription** (with redaction):\n   - From this point forward, significant exchanges are posted to Issue #NUMBER\n   - **ALWAYS apply redaction rules before posting**\n   - Spawn **Hephaestus** (`ghe:dev-thread-manager`) to manage DEV phase\n\n### If no trigger detected:\n\n- Check if there's an active `current_issue` in `.claude/ghe.local.md`\n- If yes, consider posting significant progress as checkpoints\n- **ALWAYS redact before posting to GitHub**\n- Continue with normal conversation"
          }
        ]
      }
    ],
    "Stop": [
      {
        "hooks": [
          {
            "type": "prompt",
            "prompt": "## GHE Session End (Mnemosyne)\n\n### CRITICAL: SENSITIVE DATA REDACTION\n\n**BEFORE posting the final checkpoint, you MUST redact sensitive data!**\n\nReplace with `✕✕✕✕`:\n- API keys, tokens, passwords, secrets\n- Private emails (not @noreply.github.com)\n- Username in paths: `/Users/johndoe/Code/` → `/Users/✕✕✕✕/Code/`\n- Username in paths: `/home/johndoe/` → `/home/✕✕✕✕/`\n- Username in paths: `C:\\Users\\JohnDoe\\` → `C:\\Users\\✕✕✕✕\\`\n- Real names in paths or configs\n- AWS keys, private keys, connection strings\n\n**Keep code structure intact** - only replace sensitive VALUES.\n\n---\n\nBefore ending, check for active GHE tracking:\n\n1. **Read `.claude/ghe.local.md`** to check `current_issue`\n\n2. **If active issue exists**, post final checkpoint:\n   - **REDACT all sensitive data first!**\n   - Then post:\n   ```bash\n   gh issue comment $ISSUE --body \"## Session Checkpoint\\n\\n**Status**: Session ending\\n**Progress**: [REDACTED summary of work done]\\n**Next**: [what to continue next session]\"\n   ```\n\n3. **Update SERENA memory** (local only, no redaction needed):\n   - Write session summary to `.serena/memories/activeContext.md`\n   - Include issue number, phase, and progress"
          }
        ]
      }
    ]
  }
}
