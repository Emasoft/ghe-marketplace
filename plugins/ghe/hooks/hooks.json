{
  "hooks": {
    "SessionStart": [
      {
        "hooks": [
          {
            "type": "prompt",
            "prompt": "## GHE Context Loader (Athena)\n\n### Step 0: Detect Git Repositories\n\nFirst, find all git repositories:\n\n```bash\nfind . -name \".git\" -type d 2>/dev/null | head -20\n```\n\nFor each repo found, get its remote:\n```bash\ngit -C <repo-path> remote get-url origin 2>/dev/null\n```\n\n### Step 1: Check for GHE Configuration\n\nFor each detected repo, check if `.claude/ghe.local.md` exists:\n\n**IF NO CONFIG FOUND IN ANY REPO:**\n\n→ **TRIGGER INTERACTIVE SETUP**\n\nTell the user:\n```\nGHE (GitHub-Elements) detected git repositories but no configuration found.\nStarting interactive setup...\n```\n\nThen run the SAME setup flow as `/ghe:setup`:\n\n1. **If multiple repos**: Ask which one to track\n   ```json\n   {\n     \"questions\": [{\n       \"question\": \"Which repository should GHE track?\",\n       \"header\": \"Repository\",\n       \"multiSelect\": false,\n       \"options\": [{\"label\": \"<repo-name>\", \"description\": \"<remote-url>\"}]\n     }]\n   }\n   ```\n\n2. **Ask enforcement level**:\n   ```json\n   {\n     \"questions\": [\n       {\n         \"question\": \"Enable GHE workflow tracking for this repository?\",\n         \"header\": \"Enable\",\n         \"multiSelect\": false,\n         \"options\": [\n           {\"label\": \"Yes\", \"description\": \"Activate GHE with DEV->TEST->REVIEW workflow\"},\n           {\"label\": \"No\", \"description\": \"Disable GHE for this repository\"}\n         ]\n       },\n       {\n         \"question\": \"How many warnings before enforcing phase rules?\",\n         \"header\": \"Warnings\",\n         \"multiSelect\": false,\n         \"options\": [\n           {\"label\": \"1 warning\", \"description\": \"Strict - block after first warning\"},\n           {\"label\": \"3 warnings\", \"description\": \"Standard - progressive enforcement (recommended)\"},\n           {\"label\": \"5 warnings\", \"description\": \"Lenient - more flexibility before blocking\"}\n         ]\n       }\n     ]\n   }\n   ```\n\n3. **Create config file** at `<repo>/.claude/ghe.local.md`\n4. **Create GitHub labels** (dev, test, etc.)\n5. **Update .gitignore**\n\n**IF CONFIG FOUND:**\n\n→ **Load settings and continue**\n\nParse YAML frontmatter from `.claude/ghe.local.md`:\n- `enabled`: If false, skip all GHE features silently\n- `current_issue`: Resume tracking if set\n- `current_phase`: Current workflow phase\n- `warnings_before_enforce`: Enforcement threshold\n- `violation_count`: Current violation count\n\n### Step 2: Check for Active Work (if enabled)\n\nIf `enabled: true` and `current_issue` is set:\n\n1. **Verify issue still exists**:\n   ```bash\n   gh issue view $ISSUE --json number,state,labels\n   ```\n\n2. **Report active tracking**:\n   ```\n   GHE: Resuming work on Issue #N\n   Phase: DEV/TEST/REVIEW\n   ```\n\nIf no active issue but config exists:\n1. **Check for in-progress issues**:\n   ```bash\n   gh issue list --assignee @me --label \"in-progress\" --json number,title,labels\n   ```\n2. **Report available work** if any found\n\n### Step 3: SERENA Memory Sync\n\nIf `serena_sync: true` (always true by default):\n- Check `.serena/memories/activeContext.md`\n- Verify consistency with GitHub state\n- Report discrepancies if any\n\n### Quick Reference\n\n| Scenario | Action |\n|----------|--------|\n| No repos found | Silent (not a GHE project) |\n| Repos but no config | **Trigger interactive setup** |\n| Config with enabled:false | Silent skip |\n| Config with enabled:true | Load and report active work |"
          }
        ]
      }
    ],
    "UserPromptSubmit": [
      {
        "hooks": [
          {
            "type": "prompt",
            "prompt": "## GHE Auto-Transcribe (Mnemosyne)\n\n### MANDATORY: Transcribe User Message to Issue Thread\n\n**CRITICAL**: When there is an active `current_issue` in `.claude/ghe.local.md`, you MUST post the user's message to the issue thread WITH the user's avatar banner!\n\n### Step 1: Check for Active Issue\n\n```bash\ncat .claude/ghe.local.md | grep -E '^current_issue:'\n```\n\nIf `current_issue: null` or not set → Skip transcription\nIf `current_issue: NUMBER` → Continue to Step 2\n\n### Step 2: Prepare User Message (with redaction)\n\n**BEFORE posting, redact sensitive data:**\n- API keys, tokens → `✕✕✕✕`\n- Passwords → `✕✕✕✕`\n- Private emails → `✕✕✕✕@✕✕✕✕`\n- User paths: `/Users/johndoe/` → `/Users/✕✕✕✕/`\n- AWS keys, private keys, connection strings\n\n### Step 3: Post User Message WITH AVATAR BANNER\n\n**MANDATORY FORMAT** - Post user's message:\n\n```bash\nISSUE_NUM=<current_issue from config>\nREDACTED_MSG=\"<user's message with sensitive data redacted>\"\n\ngh issue comment $ISSUE_NUM --body \"$(cat <<'EOF'\n<img src=\\\"https://avatars.githubusercontent.com/u/713559?v=4&s=77\\\" width=\\\"77\\\" align=\\\"left\\\"/>\n\n**Emasoft said:**\n<br><br>\n\n$REDACTED_MSG\nEOF\n)\"\n```\n\n### Step 4: Trigger Detection for New/Existing Issues\n\nCheck if the user's message contains any of these patterns:\n- \"lets work on this new issue\" / \"let's work on this new issue\"\n- \"lets work on issue\" / \"let's work on issue\"\n- \"lets resume working on issue\" / \"let's resume working on issue\"\n- \"work on issue #\" / \"switch to issue #\"\n\n**If trigger detected:**\n\n1. **Extract issue number** (if present)\n2. **For NEW issue**: Create issue, update config, create worktree\n3. **For EXISTING issue**: Claim, update config, create worktree\n4. **Post claim message WITH AGENT AVATAR**\n\n### Avatar URLs Reference\n\n| Name | Avatar URL |\n|------|------------|\n| **Emasoft** | `https://avatars.githubusercontent.com/u/713559?v=4&s=77` |\n| **Hephaestus** | `https://robohash.org/hephaestus.png?size=77x77&set=set3` |\n| **Artemis** | `https://robohash.org/artemis.png?size=77x77&set=set3` |\n| **Hera** | `https://robohash.org/hera.png?size=77x77&set=set3` |\n| **Athena** | `https://robohash.org/athena.png?size=77x77&set=set3` |\n\n### IMPORTANT: Never Skip Transcription!\n\nIf `current_issue` is set and NOT null, ALWAYS:\n1. Post user's message with Emasoft avatar\n2. Continue processing the request\n3. Post your response with appropriate agent avatar (based on current phase)"
          }
        ]
      }
    ],
    "Stop": [
      {
        "hooks": [
          {
            "type": "prompt",
            "prompt": "## GHE Session End (Mnemosyne)\n\n### MANDATORY: Post Final Response to Issue Thread\n\n**CRITICAL**: Before ending, if there's an active `current_issue`, you MUST post your final response/checkpoint WITH the appropriate agent avatar!\n\n### Step 1: Check for Active Issue\n\n```bash\ncat .claude/ghe.local.md | grep -E '^current_issue:'\ncat .claude/ghe.local.md | grep -E '^current_phase:'\n```\n\nIf `current_issue: null` or not set → Skip, just update SERENA memory\nIf `current_issue: NUMBER` → Continue to Step 2\n\n### Step 2: Determine Agent Identity\n\nBased on `current_phase`:\n- `dev` → Post as **Hephaestus**\n- `test` → Post as **Artemis**\n- `review` → Post as **Hera**\n- unknown/null → Post as **Athena** (orchestrator)\n\n### Step 3: Post Session Summary WITH AVATAR BANNER\n\n**MANDATORY FORMAT** - Redact sensitive data first!\n\n```bash\nISSUE_NUM=<current_issue>\nAGENT_NAME=<agent name based on phase>\nAVATAR_URL=<avatar URL for agent>\n\ngh issue comment $ISSUE_NUM --body \"$(cat <<'EOF'\n<img src=\\\"$AVATAR_URL\\\" width=\\\"77\\\" align=\\\"left\\\"/>\n\n**$AGENT_NAME said:**\n<br><br>\n\n## Session Checkpoint\n\n**Status**: Session ending\n\n### Progress\n[REDACTED summary of work done this session]\n\n### Next Steps\n[What to continue next session]\n\n### Files Modified\n- [list files if any]\nEOF\n)\"\n```\n\n### Redaction Rules (Apply BEFORE posting)\n\nReplace with `✕✕✕✕`:\n- API keys, tokens, passwords, secrets\n- Private emails (not @noreply.github.com)\n- Username in paths: `/Users/johndoe/` → `/Users/✕✕✕✕/`\n- Real names in paths or configs\n- AWS keys, private keys, connection strings\n\n### Step 4: Update SERENA Memory (local only)\n\nWrite session summary to `.serena/memories/activeContext.md`:\n- Issue number\n- Phase\n- Progress summary\n- Next steps\n\n**SERENA memory is LOCAL - no redaction needed for local files.**\n\n### Avatar URLs Reference\n\n| Agent | Phase | Avatar URL |\n|-------|-------|------------|\n| **Hephaestus** | DEV | `https://robohash.org/hephaestus.png?size=77x77&set=set3` |\n| **Artemis** | TEST | `https://robohash.org/artemis.png?size=77x77&set=set3` |\n| **Hera** | REVIEW | `https://robohash.org/hera.png?size=77x77&set=set3` |\n| **Athena** | Orchestrator | `https://robohash.org/athena.png?size=77x77&set=set3` |"
          }
        ]
      }
    ]
  }
}
