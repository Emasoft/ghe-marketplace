{
  "hooks": {
    "SessionStart": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "bash ${CLAUDE_PLUGIN_ROOT}/scripts/auto-transcribe.sh check",
            "timeout": 10
          },
          {
            "type": "command",
            "command": "bash -c 'CONFIG=\".claude/ghe.local.md\"; if [[ -f \"$CONFIG\" ]]; then ISSUE=$(grep -E \"^current_issue:\" \"$CONFIG\" 2>/dev/null | head -1 | sed \"s/^[^:]*: *//\" | tr -d '\"' | tr -d \"'\" | tr -d \" \"); if [[ -n \"$ISSUE\" && \"$ISSUE\" != \"null\" ]]; then echo \"GHE: Recovering context from Issue #$ISSUE...\"; bash ${CLAUDE_PLUGIN_ROOT}/scripts/recall-elements.sh --issue \"$ISSUE\" --recover 2>/dev/null || echo \"Element recall not available - run manually: recall-elements.sh --issue $ISSUE --recover\"; fi; fi'",
            "timeout": 30
          },
          {
            "type": "prompt",
            "prompt": "## GHE Context Loader (Athena)\n\n### Step 0: Detect Git Repositories\n\nFirst, find all git repositories:\n\n```bash\nfind . -name \".git\" -type d 2>/dev/null | head -20\n```\n\nFor each repo found, get its remote:\n```bash\ngit -C <repo-path> remote get-url origin 2>/dev/null\n```\n\n### Step 1: Check for GHE Configuration\n\nFor each detected repo, check if `.claude/ghe.local.md` exists:\n\n**IF NO CONFIG FOUND IN ANY REPO:**\n\n→ **TRIGGER INTERACTIVE SETUP**\n\nTell the user:\n```\nGHE (GitHub-Elements) detected git repositories but no configuration found.\nStarting interactive setup...\n```\n\nThen run the SAME setup flow as `/ghe:setup`:\n\n1. **If multiple repos**: Ask which one to track\n   ```json\n   {\n     \"questions\": [{\n       \"question\": \"Which repository should GHE track?\",\n       \"header\": \"Repository\",\n       \"multiSelect\": false,\n       \"options\": [{\"label\": \"<repo-name>\", \"description\": \"<remote-url>\"}]\n     }]\n   }\n   ```\n\n2. **Ask enforcement level**:\n   ```json\n   {\n     \"questions\": [\n       {\n         \"question\": \"Enable GHE workflow tracking for this repository?\",\n         \"header\": \"Enable\",\n         \"multiSelect\": false,\n         \"options\": [\n           {\"label\": \"Yes\", \"description\": \"Activate GHE with DEV->TEST->REVIEW workflow\"},\n           {\"label\": \"No\", \"description\": \"Disable GHE for this repository\"}\n         ]\n       },\n       {\n         \"question\": \"How many warnings before enforcing phase rules?\",\n         \"header\": \"Warnings\",\n         \"multiSelect\": false,\n         \"options\": [\n           {\"label\": \"1 warning\", \"description\": \"Strict - block after first warning\"},\n           {\"label\": \"3 warnings\", \"description\": \"Standard - progressive enforcement (recommended)\"},\n           {\"label\": \"5 warnings\", \"description\": \"Lenient - more flexibility before blocking\"}\n         ]\n       }\n     ]\n   }\n   ```\n\n3. **Create config file** at `<repo>/.claude/ghe.local.md`\n4. **Create GitHub labels** (phase:dev, phase:test, etc.)\n5. **Update .gitignore**\n\n**IF CONFIG FOUND:**\n\n→ **Load settings and continue**\n\nParse YAML frontmatter from `.claude/ghe.local.md`:\n- `enabled`: If false, skip all GHE features silently\n- `current_issue`: Resume tracking if set\n- `current_phase`: Current workflow phase\n- `warnings_before_enforce`: Enforcement threshold\n- `violation_count`: Current violation count\n\n### Step 2: Check for Active Work (if enabled)\n\nIf `enabled: true` and `current_issue` is set:\n\n1. **Verify issue still exists**:\n   ```bash\n   gh issue view $ISSUE --json number,state,labels\n   ```\n\n2. **Report active tracking**:\n   ```\n   GHE: Resuming work on Issue #N\n   Phase: DEV/TEST/REVIEW\n   ```\n\nIf no active issue but config exists:\n1. **Check for in-progress issues**:\n   ```bash\n   gh issue list --assignee @me --label \"in-progress\" --json number,title,labels\n   ```\n2. **Report available work** if any found\n\n### Step 3: SERENA Memory Sync\n\nIf `serena_sync: true` (always true by default):\n- Check `.serena/memories/activeContext.md`\n- Verify consistency with GitHub state\n- Report discrepancies if any\n\n### Quick Reference\n\n| Scenario | Action |\n|----------|--------|\n| No repos found | Silent (not a GHE project) |\n| Repos but no config | **Trigger interactive setup** |\n| Config with enabled:false | Silent skip |\n| Config with enabled:true | Load and report active work |\n\n---\n\n## GHE Auto-Transcribe System\n\n**STATUS**: Auto-transcription is available but **NOT ACTIVE YET**.\n\n### How It Works\n\n1. **NO transcription happens** until you explicitly choose an issue to work on\n2. Once an issue is chosen, ALL conversation exchanges are posted to that GitHub issue\n3. Every comment includes element classification badges\n\n### Element-Based Memory Recall\n\nIf you need to recall specific information from a tracked issue, use:\n\n```bash\n# Recall CODE/IMPLEMENTATIONS\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/recall-elements.sh --issue NUM --type action\n\n# Recall REQUIREMENTS/SPECS/DESIGN\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/recall-elements.sh --issue NUM --type knowledge\n\n# Recall BUGS/ISSUES/FEEDBACK\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/recall-elements.sh --issue NUM --type judgement\n\n# Smart recovery (all context)\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/recall-elements.sh --issue NUM --recover\n\n# Search within element type\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/recall-elements.sh --issue NUM --type action --search \"jwt\"\n```\n\n### To Start Transcribing\n\n**Option 1: Explicitly choose an issue**\n```bash\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/auto-transcribe.sh set-issue <NUMBER>\n```\n\n**Option 2: Use pattern in conversation** - Say:\n- \"Let's work on issue #123\"\n- \"Claim #45\"\n- \"Working on issue #99\"\n\n**Option 3: Let the system find or create an issue** (on first transcribe call)\n\n### Check Current Issue\n\n```bash\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/auto-transcribe.sh get-issue\n```\n\n### Element Classification (Once Active)\n\n| Badge | Semantic Index | When to Apply |\n|-------|----------------|---------------|\n| ![](https://img.shields.io/badge/element-knowledge-blue) | KNOWLEDGE | Specs, requirements, design, algorithms, documentation |\n| ![](https://img.shields.io/badge/element-action-green) | ACTION | Code, implementations, file changes, assets |\n| ![](https://img.shields.io/badge/element-judgement-orange) | JUDGEMENT | Reviews, feedback, bug reports, evaluations |"
          }
        ]
      }
    ],
    "UserPromptSubmit": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "bash ${CLAUDE_PLUGIN_ROOT}/scripts/check-issue-set.sh",
            "timeout": 5
          },
          {
            "type": "prompt",
            "prompt": "## GHE Issue Tracker (Mnemosyne)\n\n### CRITICAL: SENSITIVE DATA REDACTION\n\n**BEFORE posting ANY content to GitHub, you MUST redact sensitive data!**\n\nReplace the following with `✕✕✕✕` (Unicode redaction block):\n\n| Type | Pattern | Example → Redacted |\n|------|---------|--------------------|\n| **API Keys** | `sk-...`, `api_key=...`, `apikey:...` | `sk-abc123` → `✕✕✕✕` |\n| **Tokens** | `token=...`, `bearer ...`, `ghp_...`, `gho_...` | `ghp_abc123` → `✕✕✕✕` |\n| **Passwords** | `password=...`, `passwd:...`, `pwd=...` | `password=secret` → `password=✕✕✕✕` |\n| **Private Emails** | Emails NOT ending in `@noreply.github.com` or `@users.noreply.github.com` | `john@gmail.com` → `✕✕✕✕@✕✕✕✕` |\n| **User Paths (macOS)** | `/Users/<username>/...` - redact the username component | `/Users/johndoe/Code/Project` → `/Users/✕✕✕✕/Code/Project` |\n| **User Paths (Linux)** | `/home/<username>/...` - redact the username component | `/home/johndoe/projects/app` → `/home/✕✕✕✕/projects/app` |\n| **User Paths (Windows)** | `C:\\Users\\<username>\\...` - redact the username component | `C:\\Users\\JohnDoe\\Documents\\` → `C:\\Users\\✕✕✕✕\\Documents\\` |\n| **Real Names** | Names appearing in paths or configs (not GitHub usernames) | Keep GitHub usernames, redact real names |\n| **AWS Keys** | `AKIA...`, `aws_access_key_id` | `AKIAIOSFODNN7EXAMPLE` → `✕✕✕✕` |\n| **Private Keys** | `-----BEGIN ... PRIVATE KEY-----` | Entire block → `[PRIVATE KEY REDACTED]` |\n| **Connection Strings** | `mongodb://...`, `postgres://...`, `mysql://...` | Redact credentials in URL |\n\n**IMPORTANT**: Do NOT break code snippets!\n- Only replace the sensitive VALUES, not the variable names\n- Keep code structure intact\n- Example: `API_KEY = \"sk-abc123\"` → `API_KEY = \"✕✕✕✕\"`\n\n---\n\n**TRIGGER DETECTION**: Check if the user's message contains any of these patterns:\n\n**NEW ISSUE triggers** (no number = create new):\n- \"lets work on this new issue\" / \"let's work on this new issue\"\n- \"create a new issue\" / \"new issue for\"\n- \"open an issue\" / \"file an issue\"\n\n**EXISTING ISSUE triggers** (extract the number):\n- \"issue #123\" or \"issue 123\" or \"Issue #123\"\n- \"#123\" (standalone hash + number)\n- \"work on 123\" / \"work on #123\"\n- \"switch to issue 123\" / \"switch to #123\"\n- \"claim issue 123\" / \"claim #123\"\n- \"resume issue 123\" / \"resume #123\"\n- \"continue with issue 123\" / \"continue #123\"\n- \"back to issue 123\" / \"back to #123\"\n- \"lets work on issue 123\" / \"let's work on #123\"\n- \"discuss issue 123\" / \"discussing #123\"\n- \"fix issue 123\" / \"fix #123\"\n- \"close issue 123\" / \"close #123\"\n\n**GitHub URL triggers** (extract number from URL path):\n- `https://github.com/OWNER/REPO/issues/123`\n- `github.com/OWNER/REPO/issues/123`\n- Any URL containing `/issues/123` pattern\n\n**Context marker** (from CLAUDE.md injection):\n- `[Currently discussing issue n.123]`\n\n### If trigger detected:\n\n1. **Extract issue number** (if present):\n   - Pattern: `issue\\s*#?(\\d+)` - matches \"issue 123\", \"issue #123\", \"Issue#123\"\n   - Pattern: `#(\\d+)` - matches standalone \"#123\"\n   - Pattern: `/issues/(\\d+)` - matches GitHub URLs\n   - Pattern: `(\\d+)` after trigger words like \"work on\", \"claim\", \"resume\"\n   - If no number found, this is a NEW issue request\n\n2. **For NEW issue**:\n   - Ask user for issue title and description\n   - **REDACT sensitive data from title/description before creating**\n   - Create issue: `gh issue create --title \"TITLE\" --body \"BODY\" --label \"phase:dev\"`\n   - Assign to self: `gh issue edit NUMBER --add-assignee @me --add-label \"in-progress\"`\n   - Update `current_issue` in `.claude/ghe.local.md`\n   - Create worktree: `git worktree add ../ghe-worktrees/issue-NUMBER -b issue-NUMBER main`\n\n3. **For EXISTING issue**:\n   - Verify issue exists: `gh issue view NUMBER`\n   - Check current phase from labels (phase:dev, phase:test, phase:review)\n   - Claim if not assigned: `gh issue edit NUMBER --add-assignee @me --add-label \"in-progress\"`\n   - Update `current_issue` in `.claude/ghe.local.md`\n   - Create worktree if not exists\n\n4. **Start automatic transcription** (with redaction):\n   - From this point forward, significant exchanges are posted to Issue #NUMBER\n   - **ALWAYS apply redaction rules before posting**\n   - Spawn **Hephaestus** (`ghe:dev-thread-manager`) to manage DEV phase\n\n---\n\n## GHE Transcription Check\n\n**FIRST**: Check if an issue is set for transcription:\n\n```bash\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/auto-transcribe.sh get-issue\n```\n\n**IF NO ISSUE IS SET**: Do NOT transcribe. Process the user's request normally.\n\n**IF AN ISSUE IS SET**: After reading the user's message:\n\n1. **Redact sensitive data** from the user's message (use redaction rules above)\n2. **Post to GitHub** using:\n\n```bash\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/auto-transcribe.sh user \"<REDACTED_USER_MESSAGE>\"\n```\n\n3. **Then process** the user's request normally\n\n### Issue Detection Patterns\n\nIf the user's message contains any issue reference, FIRST set the issue:\n\n**Quick reference - these ALL trigger issue detection:**\n- `issue 123` / `issue #123` / `Issue#123`\n- `#123` (standalone)\n- `work on 123` / `claim 123` / `resume 123` / `fix 123`\n- `https://github.com/owner/repo/issues/123`\n- `[Currently discussing issue n.123]`\n\nExtract the number and run:\n```bash\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/auto-transcribe.sh set-issue <NUMBER>\n```\n\n**For GitHub URLs**, extract just the issue number from the path:\n```bash\n# From: https://github.com/Emasoft/my-repo/issues/45\n# Extract: 45\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/auto-transcribe.sh set-issue 45\n```\n\n---\n\n## GHE Phase Transition Detection\n\n**PHASE TRANSITION triggers** (detect and execute):\n\n| Pattern | Target Phase |\n|---------|--------------|\n| \"transition to TEST\" / \"move to TEST\" / \"ready for testing\" | TEST |\n| \"DEV complete\" / \"development done\" / \"code complete\" | TEST |\n| \"transition to REVIEW\" / \"move to REVIEW\" / \"ready for review\" | REVIEW |\n| \"tests passed\" / \"all tests pass\" / \"testing complete\" | REVIEW |\n| \"demote\" / \"send back\" / \"needs rework\" / \"back to DEV\" | DEV (demotion) |\n\n### If phase transition detected:\n\n1. **Get current issue** from `.claude/ghe.local.md`\n2. **Execute transition**:\n```bash\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/phase-transition.sh request <TARGET_PHASE> <ISSUE_NUM> \"<CONTEXT>\"\n```\n\n### Spawning Agents Directly\n\nTo spawn any GHE agent in background:\n```bash\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/spawn-agent.sh <agent-name> <issue-num> \"<context>\"\n```\n\nAvailable agents:\n- dev-thread-manager (Hephaestus) - DEV phase\n- test-thread-manager (Artemis) - TEST phase\n- review-thread-manager (Hera) - REVIEW phase\n- phase-gate (Themis) - Transition validation\n- memory-sync (Mnemosyne) - SERENA sync\n- reporter (Hermes) - Status reports\n- enforcement (Ares) - Violation detection\n\n---\n\n## GHE Feature/Bug Development Detection\n\n**IMPORTANT**: Main thread (user + Claude) is for CONVERSATION only.\nFeature/bug development happens in BACKGROUND threads managed by agents.\n\n### FEATURE REQUEST triggers:\n- \"implement ...\" / \"add feature ...\" / \"create feature ...\"\n- \"build ...\" / \"develop ...\" / \"make ...\"\n- \"I need a ...\" / \"we need ...\" / \"add a ...\"\n- \"can you add ...\" / \"please implement ...\"\n- \"new feature: ...\" / \"feature request: ...\"\n\n### BUG FIX triggers:\n- \"fix the bug ...\" / \"fix this bug ...\"\n- \"there's a bug ...\" / \"bug: ...\"\n- \"this is broken ...\" / \"not working ...\"\n- \"error when ...\" / \"crash when ...\"\n- \"please fix ...\" / \"can you fix ...\"\n\n### When feature/bug development is detected:\n\n1. **Extract title and description** from user's request\n2. **Get parent issue** (current main conversation thread)\n3. **Create background development thread**:\n```bash\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/create-feature-thread.sh <feature|bug> \"<title>\" \"<description>\" <parent-issue>\n```\n\n4. **Inform user**:\n   - Tell them a background thread was created\n   - Give them the issue number\n   - Explain that agents (Athena -> Hephaestus -> Artemis -> Hera) will handle it\n   - Continue the main conversation\n\n5. **Periodically check for review-ready threads**:\n```bash\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/check-review-ready.sh --notify\n```\n\nWhen a thread is ready for review, ask the user if they want to join.\n\n### Thread Switch triggers:\n- \"join review for #123\" / \"join #123 review\"\n- \"switch to #123\" / \"go to issue #123\"\n- \"pause this and join #123\"\n\nTo switch threads:\n```bash\n# Save current thread\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/auto-transcribe.sh get-issue  # Get current\n\n# Switch to feature thread\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/auto-transcribe.sh set-issue <NEW_ISSUE>\n```"
          }
        ]
      }
    ],
    "Stop": [
      {
        "hooks": [
          {
            "type": "prompt",
            "prompt": "## GHE Session End (Mnemosyne)\n\n### CRITICAL: SENSITIVE DATA REDACTION\n\n**BEFORE posting the final checkpoint, you MUST redact sensitive data!**\n\nReplace with `✕✕✕✕`:\n- API keys, tokens, passwords, secrets\n- Private emails (not @noreply.github.com)\n- Username in paths: `/Users/johndoe/Code/` → `/Users/✕✕✕✕/Code/`\n- Username in paths: `/home/johndoe/` → `/home/✕✕✕✕/`\n- Username in paths: `C:\\Users\\JohnDoe\\` → `C:\\Users\\✕✕✕✕\\`\n- Real names in paths or configs\n- AWS keys, private keys, connection strings\n\n**Keep code structure intact** - only replace sensitive VALUES.\n\n---\n\n## GHE: Transcribe Response (If Issue Is Active)\n\n**FIRST**: Check if transcription is active:\n\n```bash\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/auto-transcribe.sh get-issue\n```\n\n**IF NO ISSUE SET**: Skip transcription. End your response normally.\n\n**IF AN ISSUE IS SET**: Before this response ends, you MUST:\n\n1. **Summarize your response** (key points, decisions, code changes)\n2. **REDACT all sensitive data** using the redaction rules\n3. **Determine agent identity** based on work done:\n   - Code/implementation -> Hephaestus\n   - Testing/debugging -> Artemis  \n   - Review/evaluation -> Hera\n   - Planning/coordination -> Athena\n   - General -> Athena\n\n4. **Post to GitHub**:\n\n```bash\nbash ${CLAUDE_PLUGIN_ROOT}/scripts/auto-transcribe.sh assistant \"<REDACTED_RESPONSE_SUMMARY>\" \"<AGENT_NAME>\"\n```\n\n### Response Summary Format\n\nInclude:\n- What was discussed/decided\n- What actions were taken\n- What code was written/modified\n- What issues were identified\n- Next steps (if any)\n\n### Agent Selection Guide\n\n| Work Type | Agent |\n|-----------|-------|\n| Writing code, implementing features | Hephaestus |\n| Running tests, fixing bugs | Artemis |\n| Reviewing, evaluating, feedback | Hera |\n| Planning, coordinating, explaining | Athena |\n| Routing messages, communication | Hermes |\n| Moderation, policy | Ares |\n\n---\n\n### Update SERENA Memory (local only, no redaction needed)\n\n- Write session summary to `.serena/memories/activeContext.md`\n- Include issue number, phase, and progress"
          }
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": ".*",
        "hooks": [
          {
            "type": "command",
            "command": "bash ${CLAUDE_PLUGIN_ROOT}/scripts/auto_approve.sh",
            "timeout": 10000
          }
        ]
      },
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "If this bash command will make significant changes (git commit, file creation, deployment), note it for the session transcript (if transcription is active)."
          }
        ]
      }
    ]
  }
}
