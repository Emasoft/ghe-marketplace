---
description: "Configure GitHub Elements plugin for this project"
allowed-tools: ["Write", "Read", "AskUserQuestion", "Bash", "Glob"]
---

# GitHub Elements Setup Command

This command creates `.claude/ghe.local.md` with project configuration.

## Core Principles

GHE follows these non-negotiable principles:
- **No time, only order**: Workflow is phase-gated (DEV->TEST->REVIEW), never time-gated
- **Parallel agents**: Multiple agents work simultaneously on different issues/branches
- **SERENA integration**: Memory bank sync is always enabled for context survival
- **Auto worktrees**: Always enabled - required for parallel agent isolation

## Step 1: Detect Git Repositories

Find all git repositories in current directory and subdirectories:

```bash
# Find all .git directories (repos and submodules)
find . -name ".git" -type d 2>/dev/null | head -20
```

Parse the output to identify:
- Main repo (if `.git` exists in current directory)
- Sub-projects (nested `.git` directories)
- Submodules (`.git` files pointing to worktree)

For each found repo, get its remote URL:
```bash
git -C <repo-path> remote get-url origin 2>/dev/null
```

## Step 2: Select Target Repository

If multiple repos found, ask user which one to configure:

```json
{
  "questions": [
    {
      "question": "Which repository should GHE track?",
      "header": "Repository",
      "multiSelect": false,
      "options": [
        {"label": "<repo-name-1>", "description": "<remote-url-1>"},
        {"label": "<repo-name-2>", "description": "<remote-url-2>"}
      ]
    }
  ]
}
```

If only one repo found, use it automatically and inform user.

## Step 3: Check Existing Configuration

Check if `.claude/ghe.local.md` already exists in the selected repo:
- If exists, read current settings and show them
- Ask if user wants to modify or keep current settings

## Step 4: Configure Enforcement

The only meaningful user choice - how many warnings before blocking:

```json
{
  "questions": [
    {
      "question": "Enable GHE workflow tracking for this repository?",
      "header": "Enable",
      "multiSelect": false,
      "options": [
        {"label": "Yes", "description": "Activate GHE with DEV->TEST->REVIEW workflow"},
        {"label": "No", "description": "Disable GHE for this repository"}
      ]
    },
    {
      "question": "How many warnings before enforcing phase rules?",
      "header": "Warnings",
      "multiSelect": false,
      "options": [
        {"label": "1 warning", "description": "Strict - block after first warning"},
        {"label": "3 warnings", "description": "Standard - progressive enforcement (recommended)"},
        {"label": "5 warnings", "description": "Lenient - more flexibility before blocking"}
      ]
    }
  ]
}
```

## Step 5: Get Repository Owner

Get the GitHub username for the repo owner (used for PR assignments):

```bash
gh api user --jq '.login'
```

## Step 6: Create Settings File

Create `.claude/` directory in the selected repo if needed:

```bash
mkdir -p <repo-path>/.claude
```

Write settings file to `<repo-path>/.claude/ghe.local.md`:

```markdown
---
# GHE Configuration - Auto-generated by /ghe:setup
enabled: true
repo_path: "<absolute-path-to-repo>"
repo_remote: "<github-remote-url>"

# Enforcement: progressive warnings before blocking
# After this many warnings, violations will block the action
warnings_before_enforce: 3
violation_count: 0

# Owner info (for PR assignments, not for reviews)
repo_owner: "<github-username>"

# Review is handled by Hera agent, not human reviewers
review_agent: "ghe:review-thread-manager"

# These are ALWAYS enabled - core to GHE functionality
serena_sync: true
auto_worktree: true
auto_transcribe: true

# Current tracking state
current_issue: null
current_phase: null
epic_label_prefix: "epic:"
---

# GHE Configuration

This repository is configured for GHE (GitHub-Elements) workflow tracking.

## Workflow

```
DEV --> TEST --> REVIEW --> (PASS) --> merge
                    |
                    v
                (FAIL) --> back to DEV
```

**Phases are ORDER-based, not time-based.** Work progresses through phases when criteria are met, not after time passes.

## Automatic Features

These are always enabled (core GHE functionality):

| Feature | Description |
|---------|-------------|
| **SERENA Sync** | Checkpoints auto-saved to `.serena/memories/` |
| **Auto Worktree** | Each issue gets isolated git worktree for parallel work |
| **Auto Transcribe** | All exchanges posted to issue thread |
| **Review Agent** | Hera (`ghe:review-thread-manager`) handles REVIEW phase |

## Enforcement

- **Warnings before block**: <N>
- **Current violations**: 0

After <N> warnings, phase violations will block the action until resolved.

## Commands

| Phrase | Action |
|--------|--------|
| "lets work on issue #123" | Claim and activate issue |
| "lets work on this new issue" | Create new issue and activate |
| "checkpoint" | Post progress to issue thread |
| "transition to TEST" | Move to next phase (if criteria met) |

## Agents

| Phase | Agent | Role |
|-------|-------|------|
| DEV | Hephaestus | Builds and shapes the work |
| TEST | Artemis | Runs tests, hunts bugs |
| REVIEW | Hera | Evaluates quality, renders verdict |
| Orchestrator | Athena | Coordinates workflow |

## Modifying Settings

Edit this file directly. Changes take effect on Claude Code restart.

To disable GHE: set `enabled: false` in frontmatter.
To re-run setup: `/ghe:setup`
```

## Step 7: Create Required GitHub Labels

Create labels in the selected repository:

```bash
cd <repo-path>

# Phase labels
gh label create "phase:dev" --color "0E8A16" --description "Development phase" --force
gh label create "phase:test" --color "FBCA04" --description "Testing phase" --force
gh label create "phase:review" --color "1D76DB" --description "Review phase" --force

# Status labels
gh label create "ready" --color "C2E0C6" --description "Available for claiming" --force
gh label create "in-progress" --color "FEF2C0" --description "Work in progress" --force
gh label create "blocked" --color "D93F0B" --description "Has blocker" --force
gh label create "needs-input" --color "D4C5F9" --description "Waiting for input" --force

# Completion label
gh label create "completed" --color "0E8A16" --description "Review passed - merged" --force

# Violation labels
gh label create "violation:phase" --color "B60205" --description "Phase order violation" --force
gh label create "violation:scope" --color "B60205" --description "Scope violation" --force

# CI labels
gh label create "ci-failure" --color "D93F0B" --description "CI/CD failure" --force
gh label create "source:ci" --color "C5DEF5" --description "Auto-created from CI" --force

# Epic label
gh label create "epic" --color "5319E7" --description "Epic thread - orchestrates WAVES" --force

echo "GitHub Elements labels created."
```

## Step 8: Update .gitignore

Add local settings to gitignore (settings are per-machine):

```bash
cd <repo-path>
if ! grep -q ".claude/\*.local.md" .gitignore 2>/dev/null; then
  echo "" >> .gitignore
  echo "# GHE plugin settings (user-local, per-machine)" >> .gitignore
  echo ".claude/*.local.md" >> .gitignore
fi
```

## Step 9: Confirm to User

Display summary:

```
GHE Setup Complete!

Repository: <repo-name>
Path: <repo-path>
Remote: <remote-url>

Configuration:
- Enabled: Yes
- Warnings before enforce: 3
- SERENA sync: Always on
- Auto worktree: Always on
- Review agent: Hera (ghe:review-thread-manager)

Labels created: dev, test, review, ready, in-progress,
               blocked, needs-input, completed,
               violation:phase, violation:scope, ci-failure, epic

Settings saved to: <repo-path>/.claude/ghe.local.md

Next steps:
1. Say "lets work on issue #123" to start tracking an issue
2. Or "lets work on this new issue" to create and track a new one
```

## Step 10: Claude GitHub Action Setup

Ask user if they want to enable Claude GitHub Action for @claude mentions:

```json
{
  "questions": [
    {
      "question": "Enable Claude GitHub Action for @claude mentions in issues/PRs?",
      "header": "Claude Action",
      "multiSelect": false,
      "options": [
        {"label": "Yes", "description": "Recommended - enables @claude in issues and auto PR reviews"},
        {"label": "Skip", "description": "Can be set up later with /install-github-app"}
      ]
    }
  ]
}
```

If user selects "Yes", display:

```
Claude GitHub Action Setup
==========================

To enable @claude mentions in issues and PRs, you need to run
a special command that only YOU (the repo owner) can execute:

  /install-github-app https://github.com/<owner>/<repo>

This command will:
1. Guide you through GitHub App authentication
2. Create workflow files (.github/workflows/claude.yml)
3. Automatically configure secrets based on your subscription
4. Create a PR for you to review and merge

IMPORTANT: The assistant cannot run this command for you.
You must type it yourself in the chat.

After running the command:
1. Review the PR it creates
2. Merge the PR
3. @claude mentions will be active!
```

If user selects "Skip", display:

```
Skipping Claude GitHub Action setup.
You can enable it later by typing: /install-github-app <your-repo-url>
```

## Error Handling

- If no git repos found: Tell user to initialize a repo first
- If gh CLI not authenticated: Tell user to run `gh auth login`
- If label creation fails: Continue setup, warn user to create labels manually
- If user cancels: Don't create partial settings file
