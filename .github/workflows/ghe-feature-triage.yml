# GHE Automation: Event C - Feature Request â†’ Validate + DEV
# SECURITY: All user inputs passed via environment variables (secure pattern).

name: "GHE: Feature Triage"

on:
  issues:
    types: [opened, edited]

concurrency:
  group: ghe-feature-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  validate-feature:
    if: |
      (contains(github.event.issue.labels.*.name, 'enhancement') ||
       contains(github.event.issue.labels.*.name, 'feature')) &&
      !contains(github.actor, '[bot]')

    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check status
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          labels=$(gh issue view "$ISSUE_NUMBER" --json labels --jq '.labels[].name')
          echo "$labels" | grep -q "phase:dev" && echo "skip=true" >> $GITHUB_OUTPUT || echo "skip=false" >> $GITHUB_OUTPUT

      - name: Validate feature request
        if: steps.check.outputs.skip != 'true'
        uses: anthropics/claude-code-action@v1
        env:
          ISSUE_NUM: ${{ github.event.issue.number }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Validate feature request issue $ISSUE_NUM for Hephaestus (DEV agent).
            1. Read issue with gh cli
            2. Check for description and use case
            3. If valid: add phase:dev,ready labels, comment with Hephaestus avatar
            4. If incomplete: add needs-info, ask politely for details
            Use avatar: https://robohash.org/hephaestus.png?size=77x77&set=set3
