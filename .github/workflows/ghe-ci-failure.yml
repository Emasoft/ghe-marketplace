# GHE Automation: Event G - CI/CD Failure â†’ Issue for Chronos
# Creates issue when workflows fail (except GHE workflows to prevent loops).
# SECURITY: System-generated inputs only, passed via env vars.

name: "GHE: CI Failure"

on:
  workflow_run:
    workflows: ["Claude Code", "Claude Code Review"]
    types: [completed]

concurrency:
  group: ghe-ci-failure-${{ github.event.workflow_run.id }}
  cancel-in-progress: false

jobs:
  handle-failure:
    # Only run for failures, and NOT for GHE workflows (prevent loops)
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      !startsWith(github.event.workflow_run.name, 'GHE:')

    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write
      actions: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check for existing CI failure issue
        id: check-existing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
        run: |
          # Search for existing open issue for this workflow
          existing=$(gh issue list \
            --label "ci-failure" \
            --state open \
            --search "$WORKFLOW_NAME" \
            --json number \
            --jq '.[0].number // empty')

          if [ -n "$existing" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "issue_number=$existing" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create or update CI failure issue
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          WORKFLOW_URL: ${{ github.event.workflow_run.html_url }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
          EXISTING_ISSUE: ${{ steps.check-existing.outputs.issue_number }}
          HAS_EXISTING: ${{ steps.check-existing.outputs.exists }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            CI workflow "$WORKFLOW_NAME" failed (run $RUN_ID) for Chronos (REVIEW agent).

            Steps:
            1. Get failure details: gh run view $RUN_ID --json jobs
            2. Extract failed job names and error messages
            3. If $HAS_EXISTING is true:
               - Comment on issue #$EXISTING_ISSUE with:
                 - New failure timestamp
                 - Failed jobs
                 - Link to workflow run: $WORKFLOW_URL
                 - Count of consecutive failures
               - If this is 3+ consecutive failures: Add urgent label
            4. If $HAS_EXISTING is false:
               - Create issue with title: [CI #RUN_ID] $WORKFLOW_NAME failed on $HEAD_BRANCH ($HEAD_SHA_SHORT)
               - The title MUST include the run ID and be meaningful enough to understand what failed
               - Labels: phase:review, ci-failure, source:ci
               - Body: Branch, commit SHA, failed jobs, error summary, run link

            Use Argos Panoptes avatar: https://robohash.org/argos-panoptes.png?size=77x77&set=set3
            Sign comments as "Argos Panoptes (The All-Seeing)" - you are the 24/7 monitoring system.
            You are documenting this CI failure for Chronos (the CI/CD agent) to investigate when the maintainer is online.
            Don't attempt to fix - just document for review.

      - name: Handle failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          ORIG_RUN_ID: ${{ github.event.workflow_run.id }}
          RUN_ID: ${{ github.run_id }}
        run: |
          gh issue create \
            --title "[URGENT #${RUN_ID}] GHE: CI failure tracking failed for ${WORKFLOW_NAME} (run #${ORIG_RUN_ID})" \
            --label "urgent,ci-failure" \
            --body "CI failure tracking automation failed for workflow: $WORKFLOW_NAME (original run #$ORIG_RUN_ID, tracking run #$RUN_ID). Check workflow run for details."
